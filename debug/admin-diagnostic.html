<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel Diagnostic - EDUCARE TRACK</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; padding: 24px; }
    .container { max-width: 800px; margin: 0 auto; }
    h1 { color: #1e293b; margin-bottom: 8px; }
    .subtitle { color: #64748b; margin-bottom: 24px; }
    .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .card-title { font-weight: 600; color: #1e293b; margin-bottom: 12px; }
    .status-item { display: flex; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px solid #f1f5f9; }
    .status-item:last-child { border-bottom: none; }
    .status-icon { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    .status-icon.pass { background: #dcfce7; color: #16a34a; }
    .status-icon.fail { background: #fee2e2; color: #dc2626; }
    .status-icon.warn { background: #fef3c7; color: #d97706; }
    .status-icon.info { background: #e0e7ff; color: #4f46e5; }
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: #7c3aed; color: white; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; }
    .btn:hover { background: #6d28d9; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .log { background: #1e293b; color: #e2e8f0; padding: 16px; border-radius: 8px; font-family: monospace; font-size: 13px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; }
    .summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
    .summary-item { text-align: center; padding: 16px; background: #f8fafc; border-radius: 8px; }
    .summary-value { font-size: 32px; font-weight: 700; color: #1e293b; }
    .summary-label { font-size: 13px; color: #64748b; margin-top: 4px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ”§ Admin Panel Diagnostic</h1>
    <p class="subtitle">Test EDUCARE TRACK admin functionality and database connectivity</p>

    <div class="summary">
      <div class="summary-item">
        <div class="summary-value" id="testCount">0</div>
        <div class="summary-label">Tests Run</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="passCount">0</div>
        <div class="summary-label">Passed</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="failCount">0</div>
        <div class="summary-label">Issues</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Quick Test</div>
      <button class="btn" id="runTest" onclick="runDiagnostics()">â–¶ Run Diagnostics</button>
    </div>

    <div class="card">
      <div class="card-title">Results Log</div>
      <div class="log" id="log">Click "Run Diagnostics" to start testing...</div>
    </div>

    <div class="card">
      <div class="card-title">Common Issues & Solutions</div>
      <div class="status-item">
        <span class="status-icon info">â„¹</span>
        <div>
          <strong>Database not seeded</strong>
          <p style="color: #64748b; font-size: 13px;">Run: npm run seed:enterprise</p>
        </div>
      </div>
      <div class="status-item">
        <span class="status-icon info">â„¹</span>
        <div>
          <strong>Migrations not applied</strong>
          <p style="color: #64748b; font-size: 13px;">Run SQL files in supabase_migrations/ in Supabase SQL editor</p>
        </div>
      </div>
      <div class="status-item">
        <span class="status-icon info">â„¹</span>
        <div>
          <strong>Not authenticated</strong>
          <p style="color: #64748b; font-size: 13px;">Login at /auth/login.html with admin credentials</p>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from '../core/core.js';
    
    let testCount = 0;
    let passCount = 0;
    let failCount = 0;

    function log(message, type = 'info') {
      const logEl = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const icon = { pass: 'âœ…', fail: 'âŒ', warn: 'âš ï¸', info: 'â„¹ï¸' }[type] || 'â€¢';
      logEl.textContent += `\n[${timestamp}] ${icon} ${message}`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function updateCounts() {
      document.getElementById('testCount').textContent = testCount;
      document.getElementById('passCount').textContent = passCount;
      document.getElementById('failCount').textContent = failCount;
    }

    async function runDiagnostics() {
      const btn = document.getElementById('runTest');
      btn.disabled = true;
      btn.textContent = 'Running...';
      document.getElementById('log').textContent = '';
      testCount = passCount = failCount = 0;
      updateCounts();

      // Test 1: Authentication
      log('Testing authentication...', 'info');
      testCount++;
      try {
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error) {
          log(`Auth error: ${error.message}`, 'fail');
          failCount++;
        } else if (session) {
          log(`Authenticated as: ${session.user?.email || session.user?.id}`, 'pass');
          passCount++;
        } else {
          log('No active session (login required for full access)', 'warn');
          passCount++;
        }
      } catch (e) {
        log(`Connection error: ${e.message}`, 'fail');
        failCount++;
      }
      updateCounts();

      // Test tables
      const tables = [
        { name: 'Profiles (users)', table: 'profiles' },
        { name: 'Students', table: 'students' },
        { name: 'Classes', table: 'classes' },
        { name: 'Homeroom Attendance', table: 'homeroom_attendance' },
        { name: 'Announcements', table: 'announcements' },
        { name: 'School Calendar', table: 'school_calendar' },
        { name: 'Attendance Rules', table: 'attendance_rules' },
        { name: 'System Settings', table: 'system_settings' },
        { name: 'Subjects', table: 'subjects' },
        { name: 'Class Schedules', table: 'class_schedules' },
      ];

      for (const { name, table } of tables) {
        log(`Checking ${name}...`, 'info');
        testCount++;
        try {
          const { data, error } = await supabase.from(table).select('id').limit(1);
          if (error) {
            log(`Table '${table}': ${error.message}`, 'fail');
            failCount++;
          } else {
            log(`Table '${table}': Accessible`, 'pass');
            passCount++;
          }
        } catch (e) {
          log(`Table '${table}': ${e.message}`, 'fail');
          failCount++;
        }
        updateCounts();
      }

      // Test data counts
      log('\n--- Data Counts ---', 'info');
      const counts = [
        { name: 'Students', table: 'students' },
        { name: 'Classes', table: 'classes' },
        { name: 'Attendance Records', table: 'homeroom_attendance' },
        { name: 'Announcements', table: 'announcements' },
      ];

      for (const { name, table } of counts) {
        testCount++;
        try {
          const { count, error } = await supabase.from(table).select('id', { count: 'exact' });
          if (error) {
            log(`Count ${name}: Error - ${error.message}`, 'fail');
            failCount++;
          } else {
            log(`Count ${name}: ${count || 0} records`, count > 0 ? 'pass' : 'warn');
            count > 0 ? passCount++ : failCount++;
          }
        } catch (e) {
          log(`Count ${name}: ${e.message}`, 'fail');
          failCount++;
        }
        updateCounts();
      }

      // Summary
      log('\n--- Summary ---', 'info');
      if (failCount === 0) {
        log('All tests passed! Admin panel is functional.', 'pass');
      } else if (passCount > failCount) {
        log(`Partial success: ${passCount}/${testCount} tests passed`, 'warn');
        log('Check failed items above for details', 'info');
      } else {
        log(`Issues found: ${failCount}/${testCount} tests failed`, 'fail');
        log('Common solutions:', 'info');
        log('  1. Run database migrations in Supabase SQL editor', 'info');
        log('  2. Run: npm run seed:enterprise', 'info');
        log('  3. Login with admin credentials', 'info');
      }

      btn.disabled = false;
      btn.textContent = 'â–¶ Run Diagnostics';
    }

    window.runDiagnostics = runDiagnostics;
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verify Fixes - EDUCARE TRACK</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen p-6">
  <div class="max-w-4xl mx-auto">
    <header class="mb-8">
      <h1 class="text-3xl font-bold text-slate-900">üîç Verify Fixes</h1>
      <p class="text-slate-600">Check if critical issues have been resolved</p>
    </header>

    <div class="bg-white rounded-xl p-4 shadow-sm mb-6">
      <button onclick="runVerification()" class="bg-violet-600 text-white px-6 py-2 rounded-xl hover:bg-violet-700 font-medium">
        ‚ñ∂Ô∏è Run Verification
      </button>
    </div>

    <div id="results" class="space-y-4"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    
    const SUPABASE_URL = 'https://whmxpkqdveonprnbkmkr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndobXhwa3FkdmVvbnBybmJrbWtyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5OTkzODIsImV4cCI6MjA4NTU3NTM4Mn0.Ren0PAXa1iVviPdZqpYUN_2OrElgBVtvnf01eHtufK8';
    
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const results = [];

    function addResult(name, passed, message, details = null) {
      const div = document.createElement('div');
      div.className = passed 
        ? 'bg-green-50 border border-green-200 rounded-xl p-4' 
        : 'bg-red-50 border border-red-200 rounded-xl p-4';
      div.innerHTML = `
        <div class="flex items-center gap-3">
          <span class="text-2xl">${passed ? '‚úÖ' : '‚ùå'}</span>
          <div>
            <div class="font-semibold ${passed ? 'text-green-900' : 'text-red-900'}">${name}</div>
            <div class="text-sm ${passed ? 'text-green-700' : 'text-red-700'}">${message}</div>
            ${details ? `<pre class="text-xs mt-2 bg-white/50 p-2 rounded">${JSON.stringify(details, null, 2)}</pre>` : ''}
          </div>
        </div>
      `;
      document.getElementById('results').appendChild(div);
      results.push({ name, passed, message });
    }

    async function runVerification() {
      document.getElementById('results').innerHTML = '';
      results.length = 0;

      // Check auth
      const { data: { session } } = await supabase.auth.getSession();
      addResult('Authentication', !!session, session ? 'Logged in' : 'Not authenticated');

      // Test 1: Check if student_ids table has qr_code column
      try {
        const { data, error } = await supabase.from("student_ids").select("qr_code,student_id").limit(1);
        addResult(
          'student_ids table structure',
          !error,
          error ? `Error: ${error.message}` : 'Table accessible',
          error ? null : data?.[0]
        );
      } catch (e) {
        addResult('student_ids table structure', false, e.message);
      }

      // Test 2: Check if QR lookup works (by qr_code, not student_id)
      try {
        const { data, error } = await supabase.from("student_ids")
          .select("qr_code,student_id,students(id,full_name)")
          .limit(5);
        
        const qrCodes = data?.map(d => d.qr_code) || [];
        const hasEduFormat = qrCodes.every(qr => qr && /^EDU-\d{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/.test(qr));
        
        addResult(
          'QR Code Format',
          hasEduFormat && qrCodes.length > 0,
          qrCodes.length === 0 
            ? 'No QR codes found' 
            : hasEduFormat 
              ? 'All QR codes match EDU-YYYY-LLLL-XXXX' 
              : 'Invalid QR format',
          { qrSamples: qrCodes.slice(0, 3) }
        );
      } catch (e) {
        addResult('QR Code Format', false, e.message);
      }

      // Test 3: Check student_ids join with students
      try {
        const { data, error } = await supabase.from("student_ids")
          .select("id,student_id,qr_code,is_active,students(full_name,grade_level)")
          .limit(3);
        
        const hasJoin = data?.every(d => d.students && d.students.full_name);
        addResult(
          'QR to Student Join',
          hasJoin && (data?.length || 0) > 0,
          data?.length === 0 
            ? 'No ID records' 
            : hasJoin 
              ? 'Join works correctly' 
              : 'Join failed',
          data?.[0]
        );
      } catch (e) {
        addResult('QR to Student Join', false, e.message);
      }

      // Test 4: Check homeroom_attendance status values
      try {
        const { data, error } = await supabase.from("homeroom_attendance")
          .select("status")
          .limit(10);
        
        const validStatuses = ['present', 'late', 'absent', 'excused'];
        const statuses = data?.map(d => d.status) || [];
        const allValid = statuses.every(s => validStatuses.includes(s));
        
        addResult(
          'Attendance Status Values',
          statuses.length === 0 || allValid,
          statuses.length === 0 
            ? 'No attendance records' 
            : allValid 
              ? 'All statuses valid' 
              : 'Invalid statuses found',
          { uniqueStatuses: [...new Set(statuses)] }
        );
      } catch (e) {
        addResult('Attendance Status Values', false, e.message);
      }

      // Test 5: Check subject_attendance status values
      try {
        const { data, error } = await supabase.from("subject_attendance")
          .select("status")
          .limit(10);
        
        const validStatuses = ['present', 'late', 'absent', 'excused'];
        const statuses = data?.map(d => d.status) || [];
        const allValid = statuses.every(s => validStatuses.includes(s));
        
        addResult(
          'Subject Attendance Status',
          statuses.length === 0 || allValid,
          statuses.length === 0 
            ? 'No subject attendance records' 
            : allValid 
              ? 'All statuses valid' 
              : 'Invalid statuses found',
          { uniqueStatuses: [...new Set(statuses)] }
        );
      } catch (e) {
        addResult('Subject Attendance Status', false, e.message);
      }

      // Test 6: Check if issue_student_id RPC exists with correct params
      try {
        const { data, error } = await supabase.rpc('issue_student_id', { 
          student_uuid: '00000000-0000-0000-0000-000000000000' 
        });
        
        // RPC might fail due to FK constraint, but should exist
        const rpcExists = error?.code !== 'PGRST301' && !error?.message?.includes('function');
        addResult(
          'issue_student_id RPC',
          rpcExists || error?.message?.includes('foreign key'),
          rpcExists 
            ? 'RPC exists and callable' 
            : error?.message?.includes('foreign key') 
              ? 'RPC exists (FK error expected)' 
              : `Error: ${error?.message || 'Unknown'}`,
          { error }
        );
      } catch (e) {
        addResult('issue_student_id RPC', false, e.message);
      }

      // Test 7: Check profiles for is_active
      try {
        const { data, error } = await supabase.from("profiles")
          .select("id,full_name,role,is_active")
          .limit(3);
        
        const hasIsActive = data?.every(p => 'is_active' in p);
        addResult(
          'Profiles is_active',
          hasIsActive && (data?.length || 0) > 0,
          data?.length === 0 
            ? 'No profiles' 
            : hasIsActive 
              ? 'is_active column exists' 
              : 'Missing is_active',
          data?.[0]
        );
      } catch (e) {
        addResult('Profiles is_active', false, e.message);
      }

      // Test 8: Check classes for subject_teachers array
      try {
        const { data, error } = await supabase.from("classes")
          .select("id,grade_level,subject_teachers")
          .limit(3);
        
        const hasArray = data?.every(c => Array.isArray(c.subject_teachers));
        addResult(
          'Classes subject_teachers array',
          hasArray || (data?.length || 0) === 0,
          data?.length === 0 
            ? 'No classes' 
            : hasArray 
              ? 'subject_teachers is array' 
              : 'Not array type',
          data?.[0]
        );
      } catch (e) {
        addResult('Classes subject_teachers array', false, e.message);
      }

      // Summary
      const passed = results.filter(r => r.passed).length;
      const total = results.length;
      
      const summary = document.createElement('div');
      summary.className = `mt-6 p-4 rounded-xl ${passed === total ? 'bg-green-100' : 'bg-yellow-100'}`;
      summary.innerHTML = `
        <div class="font-bold ${passed === total ? 'text-green-900' : 'text-yellow-900'}">
          ${passed}/${total} tests passed
        </div>
        <div class="text-sm ${passed === total ? 'text-green-700' : 'text-yellow-700'}">
          ${passed === total ? 'All critical issues resolved!' : 'Some issues remain'}
        </div>
      `;
      document.getElementById('results').appendChild(summary);
    }

    window.runVerification = runVerification;
  </script>
</body>
</html>

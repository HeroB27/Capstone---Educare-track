-- ==================== PREP ====================
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- ==================== DROP TABLES ====================
DROP TABLE IF EXISTS public.tap_logs CASCADE;
DROP TABLE IF EXISTS public.system_settings CASCADE;
DROP TABLE IF EXISTS public.student_ids CASCADE;
DROP TABLE IF EXISTS public.password_reset_requests CASCADE;
DROP TABLE IF EXISTS public.excuse_letters CASCADE;
DROP TABLE IF EXISTS public.school_calendar CASCADE;
DROP TABLE IF EXISTS public.notifications CASCADE;
DROP TABLE IF EXISTS public.announcements CASCADE;
DROP TABLE IF EXISTS public.clinic_passes CASCADE;
DROP TABLE IF EXISTS public.clinic_visits CASCADE;
DROP TABLE IF EXISTS public.class_schedules CASCADE;
DROP TABLE IF EXISTS public.subject_attendance CASCADE;
DROP TABLE IF EXISTS public.homeroom_attendance CASCADE;
DROP TABLE IF EXISTS public.attendance_rules CASCADE;
DROP TABLE IF EXISTS public.subjects CASCADE;
DROP TABLE IF EXISTS public.students CASCADE;
DROP TABLE IF EXISTS public.classes CASCADE;
DROP TABLE IF EXISTS public.profiles CASCADE;

DROP FUNCTION IF EXISTS public.get_student_attendance_summary CASCADE;
DROP FUNCTION IF EXISTS public.issue_student_id CASCADE;
DROP FUNCTION IF EXISTS public.update_updated_at_column CASCADE;

-- ==================== CORE ====================

CREATE TABLE public.profiles (
    id uuid PRIMARY KEY REFERENCES auth.users(id),
    full_name text NOT NULL,
    username text UNIQUE,
    phone text,
    email text,
    role text CHECK (role IN ('admin','teacher','parent','guard','clinic')),
    is_active boolean DEFAULT true,
    is_gatekeeper boolean DEFAULT false,
    address text,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now()
);

CREATE TABLE public.classes (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    grade_level text NOT NULL,
    strand text,
    homeroom_teacher_id uuid REFERENCES public.profiles(id),
    room text,
    subject_teachers uuid[] DEFAULT '{}',
    is_active boolean DEFAULT true,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now()
);

CREATE TABLE public.students (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    full_name text NOT NULL,
    lrn text UNIQUE,
    grade_level text NOT NULL,
    strand text,
    class_id uuid REFERENCES public.classes(id),
    address text,
    parent_id uuid REFERENCES public.profiles(id),
    current_status text DEFAULT 'out',
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now()
);

CREATE TABLE public.subjects (
    code text PRIMARY KEY,
    name text NOT NULL,
    grade_level text,
    strand text
);

-- ==================== ATTENDANCE ====================

CREATE TABLE public.attendance_rules (
    grade_level text PRIMARY KEY,
    entry_time time,
    grace_until time,
    late_until time
);

CREATE TABLE public.homeroom_attendance (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    student_id uuid REFERENCES public.students(id),
    class_id uuid REFERENCES public.classes(id),
    date date,
    tap_in_time timestamptz,
    tap_out_time timestamptz,
    status text,
    remarks text,
    UNIQUE(student_id, date)
);

CREATE TABLE public.subject_attendance (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    student_id uuid REFERENCES public.students(id),
    subject_code text REFERENCES public.subjects(code),
    date date,
    status text,
    UNIQUE(student_id, subject_code, date)
);

-- ==================== CLINIC ====================

CREATE TABLE public.clinic_visits (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    student_id uuid REFERENCES public.students(id),
    visit_time timestamptz DEFAULT now(),
    reason text NOT NULL,
    treated_by uuid REFERENCES public.profiles(id),
    notes text,
    status text DEFAULT 'in_clinic',
    created_at timestamptz DEFAULT now()
);

CREATE TABLE public.clinic_passes (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    student_id uuid REFERENCES public.students(id),
    issued_by uuid REFERENCES public.profiles(id),
    status text DEFAULT 'pending',
    created_at timestamptz DEFAULT now()
);

-- ==================== COMMUNICATION ====================

CREATE TABLE public.announcements (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    title text,
    body text,
    audience_teachers boolean,
    audience_parents boolean,
    audience_guard boolean,
    audience_clinic boolean,
    created_by uuid REFERENCES public.profiles(id),
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now()
);

CREATE TABLE public.notifications (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    recipient_id uuid REFERENCES public.profiles(id),
    verb text,
    read boolean DEFAULT false,
    created_at timestamptz DEFAULT now()
);

-- ==================== ADMIN ====================

CREATE TABLE public.school_calendar (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    type text,
    title text,
    start_date date,
    end_date date,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now()
);

CREATE TABLE public.excuse_letters (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    student_id uuid REFERENCES public.students(id),
    parent_id uuid REFERENCES public.profiles(id),
    absent_date date,
    reason text,
    status text DEFAULT 'pending',
    created_at timestamptz DEFAULT now()
);

CREATE TABLE public.password_reset_requests (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    requested_user_id text,
    requested_by_profile_id uuid REFERENCES public.profiles(id),
    status text DEFAULT 'pending',
    created_at timestamptz DEFAULT now()
);

-- ==================== IDS ====================

CREATE TABLE public.student_ids (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    student_id uuid REFERENCES public.students(id),
    qr_code text UNIQUE,
    is_active boolean DEFAULT true,
    created_at timestamptz DEFAULT now()
);

-- ==================== SYSTEM ====================

CREATE TABLE public.system_settings (
    key text PRIMARY KEY,
    value jsonb
);

CREATE TABLE public.tap_logs (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    student_id uuid REFERENCES public.students(id),
    gatekeeper_id uuid REFERENCES public.profiles(id),
    tap_type text,
    timestamp timestamptz DEFAULT now()
);

-- ==================== FUNCTIONS ====================

CREATE FUNCTION public.issue_student_id(student_uuid uuid)
RETURNS uuid LANGUAGE plpgsql AS $$
DECLARE new_id uuid;
BEGIN
    INSERT INTO public.student_ids(student_id, qr_code)
    VALUES (student_uuid, student_uuid || '-' || extract(epoch from now()))
    RETURNING id INTO new_id;
    RETURN new_id;
END;
$$;

CREATE FUNCTION public.get_student_attendance_summary(student_uuid uuid)
RETURNS TABLE(total int, present int, absent int) LANGUAGE sql AS $$
    SELECT 
        COUNT(*),
        COUNT(*) FILTER (WHERE status='present'),
        COUNT(*) FILTER (WHERE status='absent')
    FROM public.homeroom_attendance
    WHERE student_id = student_uuid;
$$;

-- ==================== UPDATED_AT TRIGGER ====================

CREATE FUNCTION public.update_updated_at_column()
RETURNS trigger LANGUAGE plpgsql AS $$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END;
$$;

CREATE TRIGGER trg_profiles BEFORE UPDATE ON public.profiles
FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER trg_students BEFORE UPDATE ON public.students
FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER trg_classes BEFORE UPDATE ON public.classes
FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER trg_announcements BEFORE UPDATE ON public.announcements
FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

-- ==================== REALTIME ====================
ALTER PUBLICATION supabase_realtime ADD TABLE public.announcements;
ALTER PUBLICATION supabase_realtime ADD TABLE public.notifications;
ALTER PUBLICATION supabase_realtime ADD TABLE public.clinic_visits;

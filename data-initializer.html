<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Data Seeder - Educare Track</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .log-container { max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .progress-bar { transition: width 0.3s ease; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <div class="flex items-center space-x-4 mb-8">
            <div class="bg-violet-600 p-3 rounded-2xl shadow-lg shadow-violet-500/20">
                <i data-lucide="database" class="w-8 h-8 text-white"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold">ðŸš€ Production Seeding Agent</h1>
                <p class="text-slate-400">Auth-Enabled, Zero-Null Database Population</p>
            </div>
        </div>

        <div class="bg-amber-900/20 border border-amber-500/50 p-4 rounded-xl mb-8 flex items-start space-x-3">
            <i data-lucide="alert-triangle" class="text-amber-500 w-6 h-6 mt-1"></i>
            <div>
                <p class="font-bold text-amber-500 uppercase text-xs tracking-widest">Action Required</p>
                <p class="text-sm text-amber-200/80">To create loggable dummy users, you must provide your <b>Supabase Service Role Key</b>. This key is used only during this session to call the Admin Auth API.</p>
                <input type="password" id="serviceKey" class="w-full mt-3 bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-violet-500" placeholder="paste your service_role key here...">
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl">
                <h2 class="text-lg font-bold mb-4 flex items-center">
                    <i data-lucide="list-checks" class="w-5 h-5 mr-2 text-violet-400"></i>
                    Final Seeding Scope
                </h2>
                <ul class="space-y-3 text-sm text-slate-300">
                    <li class="flex justify-between"><span>Admin</span><span class="text-violet-400 font-bold">1 Loggable</span></li>
                    <li class="flex justify-between"><span>Teachers (Homeroom/Subject)</span><span class="text-violet-400 font-bold">30 Loggable</span></li>
                    <li class="flex justify-between"><span>Guards & Clinic</span><span class="text-violet-400 font-bold">2 Each Loggable</span></li>
                    <li class="flex justify-between"><span>Students (5 per class)</span><span class="text-violet-400 font-bold">65 Total</span></li>
                    <li class="flex justify-between"><span>Attendance History</span><span class="text-violet-400 font-bold">Nov - Present</span></li>
                </ul>
                <div class="mt-8 space-y-4">
                    <button id="startBtn" class="w-full py-4 bg-violet-600 hover:bg-violet-700 text-white rounded-xl font-bold transition-all shadow-lg shadow-violet-600/20 flex items-center justify-center space-x-2">
                        <i data-lucide="play" class="w-5 h-5"></i>
                        <span>Begin Full Seeding</span>
                    </button>
                    <button id="clearDataBtn" class="w-full py-3 bg-slate-700 hover:bg-red-600 text-slate-300 hover:text-white rounded-xl font-bold transition-all flex items-center justify-center space-x-2 border border-slate-600 hover:border-red-500">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                        <span>Wipe All Tables</span>
                    </button>
                </div>
            </div>

            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl">
                <h2 class="text-lg font-bold mb-4 flex items-center">
                    <i data-lucide="activity" class="w-5 h-5 mr-2 text-blue-400"></i>
                    Status
                </h2>
                <div class="space-y-6">
                    <div>
                        <div class="flex justify-between text-xs mb-2">
                            <span class="text-slate-400">Overall Progress</span>
                            <span id="progressPercent" class="text-blue-400 font-bold">0%</span>
                        </div>
                        <div class="w-full h-3 bg-slate-700 rounded-full overflow-hidden">
                            <div id="progressBar" class="progress-bar h-full bg-blue-500 w-0"></div>
                        </div>
                    </div>
                    <div id="currentAction" class="text-sm font-medium text-slate-200 italic">Ready to seed...</div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-900/50 p-3 rounded-xl border border-slate-700/50 text-center">
                            <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest">Users Created</p>
                            <p id="countUsers" class="text-xl font-bold">0</p>
                        </div>
                        <div class="bg-slate-900/50 p-3 rounded-xl border border-slate-700/50 text-center">
                            <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest">Attendance Logs</p>
                            <p id="countAtt" class="text-xl font-bold">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-slate-800 rounded-2xl border border-slate-700 shadow-xl overflow-hidden">
            <div class="p-4 bg-slate-700/30 border-b border-slate-700 flex justify-between items-center">
                <h3 class="text-sm font-bold uppercase tracking-widest text-slate-400">Seeding Logs</h3>
                <button id="clearLogs" class="text-[10px] text-slate-500 hover:text-slate-300 uppercase font-bold">Clear</button>
            </div>
            <div id="logs" class="log-container p-4 text-slate-400">
                <div>[SYSTEM] Awaiting Service Role Key and Start command...</div>
            </div>
        </div>
    </div>

    <script src="./js/supabase-config.js"></script>
    <script type="module">
        const state = { progress: 0, usersCreated: 0, attCreated: 0 };
        const firstNames = ['Juan', 'Maria', 'Jose', 'Elena', 'Ricardo', 'Liza', 'Antonio', 'Teresita', 'Gabriel', 'Carmelita', 'Mateo', 'Angelita', 'Dominador', 'Priscila', 'Ramon', 'Imelda', 'Felipe', 'Corazon', 'Emilio', 'Lourdes'];
        const lastNames = ['Pascua', 'Bautista', 'CariÃ±o', 'Domogan', 'Molintas', 'Fianza', 'Aliping', 'Cosalan', 'Vergara', 'Mauricio', 'Tabora', 'Bugnosen', 'Hamada', 'Okubo', 'Bello', 'Perez', 'Garcia', 'Dimalanta', 'Santos', 'Reyes'];
        const grades = ['Kinder', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10'];
        const strands = [];
        const subjects = ['MATH', 'SCI', 'ENG', 'FIL', 'MAPEH', 'AP', 'ESP'];

        const log = (msg, type = 'info') => {
            const el = document.getElementById('logs');
            const div = document.createElement('div');
            const color = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-emerald-400' : type === 'warning' ? 'text-amber-400' : 'text-slate-400';
            div.className = `mb-1 ${color}`;
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            el.appendChild(div);
            el.scrollTop = el.scrollHeight;
        };

        const updateUI = (action) => {
            if (action) document.getElementById('currentAction').innerText = action;
            document.getElementById('progressBar').style.width = `${state.progress}%`;
            document.getElementById('progressPercent').innerText = `${Math.round(state.progress)}%`;
            document.getElementById('countUsers').innerText = state.usersCreated;
            document.getElementById('countAtt').innerText = state.attCreated;
        };

        const generateStaffID = (role, year, phone) => {
            const prefix = role === 'admin' ? 'ADM' : role === 'teacher' ? 'TCH' : role === 'clinic' ? 'CLC' : 'GRD';
            const last4Phone = phone.toString().replace(/\D/g, '').slice(-4);
            const randomStr = Math.random().toString(36).substring(2, 6).toUpperCase();
            return `${prefix}-${year}-${last4Phone}-${randomStr}`;
        };

        const generateStudentID = (year, LRN) => {
            const last4 = LRN.toString().slice(-4);
            const randomStr = Math.random().toString(36).substring(2, 6).toUpperCase();
            return `EDU-${year}-${last4}-${randomStr}`;
        };

        async function seed() {
            const serviceKey = document.getElementById('serviceKey').value;
            if (!serviceKey) return log('ERROR: Service Role Key is required for loggable users!', 'error');

            const adminClient = supabase.createClient(window.SUPABASE_URL, serviceKey);
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            log('Initiating Auth-Enabled Seeding Sequence...', 'success');

            try {
                const currentYear = new Date().getFullYear();
                const defaultPassword = 'password123';

                // 1. Core Staff
                log('Seeding Core Staff (Admin, Guards, Clinic)...');
                const staffRoles = [
                    { role: 'admin', email: 'admin@educare.edu', name: 'Super Admin', phone: '09170000001' },
                    { role: 'guard', email: 'guard1@educare.edu', name: 'Guard Ricardo', phone: '09180000001' },
                    { role: 'guard', email: 'guard2@educare.edu', name: 'Guard Antonio', phone: '09180000002' },
                    { role: 'clinic', email: 'nurse1@educare.edu', name: 'Nurse Teresita', phone: '09190000001' },
                    { role: 'clinic', email: 'nurse2@educare.edu', name: 'Nurse Maria', phone: '09190000002' }
                ];

                const guardIds = [];
                let firstAdminId = null;
                for (const s of staffRoles) {
                    const { data: user, error: authErr } = await adminClient.auth.admin.createUser({
                        email: s.email, password: defaultPassword, email_confirm: true,
                        user_metadata: { full_name: s.name, role: s.role, username: s.email.split('@')[0], phone: s.phone }
                    });
                    if (authErr) log(`Auth failed for ${s.email}: ${authErr.message}`, 'warning');
                    else {
                        state.usersCreated++;
                        const uid = user.user.id;
                        if (s.role === 'guard') guardIds.push(uid);
                        if (s.role === 'admin') {
                            await adminClient.from('admin_staff').upsert({ id: uid, position: 'School Principal' });
                            firstAdminId = uid;
                        }
                        if (s.role === 'clinic') await adminClient.from('clinic_staff').upsert({ id: uid, license_no: 'RN-2026-001' });
                        if (s.role === 'guard') await adminClient.from('guards').upsert({ id: uid, shift: 'Day', assigned_gate: 'Main Gate' });
                    }
                }
                state.progress = 10; updateUI('Core staff ready.');

                // 2. 30 Teachers
                log('Seeding 30 Teachers...');
                const teacherIds = [];
                for (let i = 1; i <= 30; i++) {
                    const email = `teacher${i}@educare.edu`;
                    const phone = `092000000${i.toString().padStart(2, '0')}`;
                    const { data: user, error } = await adminClient.auth.admin.createUser({
                        email, password: defaultPassword, email_confirm: true,
                        user_metadata: { full_name: `${firstNames[i % 20]} ${lastNames[(i + 5) % 20]}`, role: 'teacher', username: `teacher${i}`, phone }
                    });
                    if (!error) {
                        state.usersCreated++;
                        teacherIds.push(user.user.id);
                        await adminClient.from('teachers').upsert({ id: user.user.id, employee_no: `EMP-${2026000 + i}`, is_homeroom: i <= 13, is_gatekeeper: i > 27 });
                    }
                }
                state.progress = 30; updateUI('Teachers ready.');

                // 3. Curriculum
                log('Seeding Subjects...');
                const classIds = [];
                const subjectCodes = [];

                // Seed Subjects for all grades
                for (const g of grades) {
                    for (const s of subjects) {
                        const code = `${s}-${g}`;
                        const { error } = await adminClient.from('subjects').upsert({
                            code,
                            name: `${s} for Grade ${g}`,
                            grade: g,
                            type: 'core',
                            created_by: firstAdminId,
                            updated_by: firstAdminId
                        });
                        if (!error) subjectCodes.push(code);
                    }
                }

                for (let i = 0; i < grades.length; i++) {
                    const grade = grades[i];
                    const strand = (grade === '11' || grade === '12') ? strands[i % 4] : null;
                    const id = grade + (strand ? '-' + strand : '');
                    
                    // Teachers 1-13 are Homeroom Advisers
                    await adminClient.from('classes').upsert({ 
                        id, grade, strand, 
                        adviser_id: i < 13 ? teacherIds[i] : null, 
                        level: parseInt(grade) >= 7 ? 'High School' : (grade === 'Kinder' ? 'Kinder' : 'Elementary')
                    });
                    classIds.push(id);

                    // Seed Schedules for each class
                    for (let j = 0; j < 3; j++) {
                        await adminClient.from('class_schedules').insert({
                            class_id: id,
                            subject_code: subjectCodes[Math.floor(Math.random() * subjectCodes.length)],
                            teacher_id: teacherIds[Math.floor(Math.random() * teacherIds.length)],
                            day_of_week: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'][j],
                            start_time: `${8 + j}:00:00`,
                            end_time: `${9 + j}:00:00`
                        });
                    }
                }
                state.progress = 40; updateUI('Classes and Schedules ready.');

                // 4. Parents & Students (5 per class)
                log('Seeding Students & Multi-Child Parents...');
                const studentRecords = [];
                let studentCount = 0;
                
                for (let i = 0; i < classIds.length; i++) {
                    const clsId = classIds[i];
                    const grade = grades[i];

                    for (let j = 1; j <= 5; j++) {
                        studentCount++;
                        // One parent per ~2.5 students to simulate multi-child
                        const parentIdx = Math.ceil(studentCount / 2.5);
                        const pEmail = `parent${parentIdx}@email.com`;
                        const pPhone = `093000000${parentIdx.toString().padStart(2, '0')}`;
                        
                        let parentId;
                        const { data: pCheck } = await adminClient.from('profiles').select('id').eq('email', pEmail).single();
                        if (!pCheck) {
                            const { data: pUser, error: pAuthErr } = await adminClient.auth.admin.createUser({
                                email: pEmail, password: defaultPassword, email_confirm: true,
                                user_metadata: { full_name: `Parent ${lastNames[parentIdx % 20]}`, role: 'parent', username: `parent${parentIdx}`, phone: pPhone }
                            });
                            if (pAuthErr) {
                                log(`Parent Auth Error: ${pAuthErr.message}`, 'warning');
                                continue;
                            }
                            parentId = pUser.user.id;
                            await adminClient.from('parents').upsert({ id: parentId, address: 'Purok 4 Irisan Baguio City' });
                            state.usersCreated++;
                        } else parentId = pCheck.id;

                        // Create Student
                        const lrn = `100000${studentCount.toString().padStart(3, '0')}`;
                        const studentId = generateStudentID(currentYear, lrn);
                        const { data: stu, error: stuErr } = await adminClient.from('students').insert({
                            id: studentId, lrn, full_name: `${firstNames[studentCount % 20]} ${lastNames[(studentCount + 10) % 20]}`,
                            grade_level: grade, class_id: clsId, current_status: 'out', address: 'Purok 4 Irisan Baguio City'
                        }).select().single();
                        
                        if (stuErr) {
                            log(`Student Insert Error: ${stuErr.message}`, 'error');
                            continue;
                        }

                        if (stu) {
                            studentRecords.push(stu);
                            await adminClient.from('parent_students').insert({ parent_id: parentId, student_id: studentId, relationship: 'Parent' });
                            await adminClient.from('qr_codes').insert({ student_id: studentId, qr_hash: studentId, is_active: true });
                        }
                    }
                }
                state.progress = 70; updateUI('Students & Parents ready.');

                // 5. Bulk Attendance (Nov - Present)
                log('Generating 3 months of Attendance Logs...');
                const startDate = new Date('2025-11-01');
                const endDate = new Date();
                let curr = new Date(startDate);
                while (curr <= endDate) {
                    if (curr.getDay() !== 0 && curr.getDay() !== 6) { // Weekdays only
                        const dateStr = curr.toISOString().split('T')[0];
                        const batch = studentRecords.map(s => {
                            const roll = Math.random();
                            let status = roll < 0.85 ? 'present' : roll < 0.95 ? 'late' : 'absent';
                            return {
                                student_id: s.id, date: dateStr, status, 
                                timestamp: `${dateStr}T${status === 'late' ? '08:15:00' : '07:15:00'}Z`,
                                method: status === 'absent' ? 'none' : 'qr', entry_type: status === 'absent' ? 'none' : 'entry',
                                recorded_by: guardIds[0], remarks: status === 'late' ? 'Entered Late' : 'On Time'
                            };
                        });
                        await adminClient.from('attendance').insert(batch);
                        state.attCreated += batch.length;
                    }
                    curr.setDate(curr.getDate() + 1);
                    state.progress = 70 + (30 * (curr - startDate) / (endDate - startDate));
                    updateUI(`Seeding logs for ${curr.toDateString()}`);
                }

                state.progress = 100; updateUI('Seeding Complete!');
                log('System is now 100% operational with loggable dummy users.', 'success');

                // 6. Final Utilities
                log('Seeding Rules and Announcements...');
                const rules = [
                    { grade_level: 'Kinder', in_start: '07:30:00', grace_until: '08:00:00', late_until: '08:30:00', dismissal_time: '11:30:00', late_arrival_threshold: 60 },
                    { grade_level: '1', in_start: '07:30:00', grace_until: '07:45:00', late_until: '08:15:00', dismissal_time: '13:00:00', late_arrival_threshold: 60 },
                    { grade_level: '2', in_start: '07:30:00', grace_until: '07:45:00', late_until: '08:15:00', dismissal_time: '13:00:00', late_arrival_threshold: 60 },
                    { grade_level: '3', in_start: '07:30:00', grace_until: '07:45:00', late_until: '08:15:00', dismissal_time: '13:00:00', late_arrival_threshold: 60 },
                    { grade_level: '4', in_start: '07:30:00', grace_until: '07:45:00', late_until: '08:15:00', dismissal_time: '15:00:00', late_arrival_threshold: 60 },
                    { grade_level: '5', in_start: '07:30:00', grace_until: '07:45:00', late_until: '08:15:00', dismissal_time: '15:00:00', late_arrival_threshold: 60 },
                    { grade_level: '6', in_start: '07:30:00', grace_until: '07:45:00', late_until: '08:15:00', dismissal_time: '15:00:00', late_arrival_threshold: 60 },
                    { grade_level: '7', in_start: '07:30:00', grace_until: '07:45:00', late_until: '08:15:00', dismissal_time: '16:00:00', late_arrival_threshold: 60 },
                    { grade_level: '8', in_start: '07:30:00', grace_until: '07:45:00', late_until: '08:15:00', dismissal_time: '16:00:00', late_arrival_threshold: 60 },
                    { grade_level: '9', in_start: '07:30:00', grace_until: '07:45:00', late_until: '08:15:00', dismissal_time: '16:00:00', late_arrival_threshold: 60 },
                    { grade_level: '10', in_start: '07:30:00', grace_until: '07:45:00', late_until: '08:15:00', dismissal_time: '16:00:00', late_arrival_threshold: 60 }
                ];
                for (const r of rules) await adminClient.from('attendance_rules').upsert({ ...r, created_by: firstAdminId, updated_by: firstAdminId });

                if (firstAdminId) {
                    await adminClient.from('system_settings').upsert([
                        { key: 'school_info', value: { name: 'Educare Academy' }, created_by: firstAdminId, updated_by: firstAdminId },
                        { key: 'academic_year', value: { year: '2025-2026' }, created_by: firstAdminId, updated_by: firstAdminId }
                    ], { onConflict: 'key' });

                    await adminClient.from('announcements').insert([
                        { title: 'Welcome to SY 2025-2026', content: 'Classes start today!', audience: ['parent', 'teacher'], posted_by: firstAdminId },
                        { title: 'Emergency Suspension', content: 'Due to typhoon, classes are suspended.', audience: ['all'], posted_by: firstAdminId }
                    ]);
                }

                startBtn.innerText = 'Seeding Successful';
            } catch (err) {
                log(err.message, 'error');
                startBtn.disabled = false;
            }
        }

        document.getElementById('startBtn').addEventListener('click', seed);
        document.getElementById('clearDataBtn').addEventListener('click', async () => {
            const serviceKey = document.getElementById('serviceKey').value;
            if (!serviceKey) return log('ERROR: Service Role Key is required to wipe Auth users!', 'error');
            if (!confirm('WIPE EVERYTHING? This will delete ALL users and ALL data.')) return;
            
            const adminClient = supabase.createClient(window.SUPABASE_URL, serviceKey);
            log('Starting full database and auth wipe...', 'warning');

            try {
                // 1. Wipe Auth Users
                const { data: { users }, error: listErr } = await adminClient.auth.admin.listUsers();
                if (listErr) throw listErr;
                
                log(`Deleting ${users.length} auth users...`);
                for (const u of users) {
                    await adminClient.auth.admin.deleteUser(u.id);
                }
                log('Auth users cleared.', 'success');

                // 2. Wipe Database Tables (Cascade will handle most)
                const tables = ['attendance', 'students', 'profiles', 'subjects', 'classes', 'announcements', 'school_calendar'];
                for (const t of tables) {
                    try {
                        await adminClient.from(t).delete();
                    } catch (e) {}
                }
                
                log('Database tables cleared.', 'success');
                state.usersCreated = 0;
                state.attCreated = 0;
                state.progress = 0;
                updateUI('System Wiped Clean');
            } catch (err) {
                log('Wipe failed: ' + err.message, 'error');
            }
        });
        if (window.lucide) window.lucide.createIcons();
    </script>
</body>
</html>

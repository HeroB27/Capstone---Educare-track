-- EDUCARE TRACK - FINAL DATABASE SCHEMA
-- Last Updated: 2026-02-02

CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- 1. Profiles & Role-based Sub-tables
CREATE TABLE public.profiles (
  id uuid DEFAULT gen_random_uuid(),
  phone text,
  email text,
  avatar_url text,
  full_name text,
  username text,
  password text,
  photo_url text,
  is_active boolean DEFAULT true,
  nickname text,
  gender text,
  birthdate date,
  role text,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  CHECK (role IN ('admin','teacher','student','parent','guard','clinic'))
);

CREATE TABLE public.admin_staff (
  id uuid,
  position text,
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (id) REFERENCES public.profiles(id)
);

CREATE TABLE public.teachers (
  id uuid,
  employee_no text UNIQUE,
  is_homeroom boolean DEFAULT false,
  is_gatekeeper boolean DEFAULT false,
  assigned_subjects text[],
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (id) REFERENCES public.profiles(id)
);

CREATE TABLE public.parents (
  id uuid,
  address text,
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (id) REFERENCES public.profiles(id)
);

CREATE TABLE public.guards (
  id uuid,
  shift text,
  assigned_gate text,
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (id) REFERENCES public.profiles(id)
);

CREATE TABLE public.clinic_staff (
  id uuid,
  license_no text,
  position text,
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (id) REFERENCES public.profiles(id)
);

-- 2. Academic Structure
CREATE TABLE public.classes (
  id text,
  grade text,
  strand text,
  adviser_id uuid,
  room text,
  level text,
  is_active boolean DEFAULT true,
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (adviser_id) REFERENCES public.teachers(id)
);

CREATE TABLE public.students (
  id text,
  lrn text UNIQUE,
  full_name text,
  dob date,
  gender text,
  grade_level text,
  strand text,
  class_id text,
  address text,
  photo_url text,
  current_status text DEFAULT 'out', -- 'out', 'present', 'late', 'clinic', 'excused'
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (class_id) REFERENCES public.classes(id),
  CHECK (id <> '')
);

CREATE TABLE public.parent_students (
  id uuid DEFAULT gen_random_uuid(),
  parent_id uuid,
  student_id text,
  relationship text,
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (parent_id) REFERENCES public.parents(id),
  FOREIGN KEY (student_id) REFERENCES public.students(id),
  UNIQUE (parent_id, student_id)
);

CREATE TABLE public.subjects (
  code text,
  name text,
  grade text NOT NULL,
  semester text, -- Added: '1', '2', or NULL for whole year
  strand text, -- Added: 'STEM', 'ABM', 'HUMSS', 'ICT', or NULL for general
  type text, -- Added: 'core', 'applied', 'specialized'
  description text,
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (code)
);

CREATE TABLE public.class_schedules (
  id uuid DEFAULT gen_random_uuid(),
  class_id text,
  subject_code text,
  teacher_id uuid,
  day_of_week text,
  start_time time,
  end_time time,
  semester text, -- Added: '1' or '2' for SHS tracking
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (class_id) REFERENCES public.classes(id),
  FOREIGN KEY (subject_code) REFERENCES public.subjects(code),
  FOREIGN KEY (teacher_id) REFERENCES public.teachers(id),
  CHECK (end_time > start_time)
);

-- 3. Attendance & Validation
CREATE TABLE public.attendance_rules (
  id uuid DEFAULT gen_random_uuid(),
  grade_level text,
  in_start time,
  grace_until time,
  late_until time,
  min_subject_minutes int DEFAULT 30,
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  UNIQUE (grade_level)
);

CREATE TABLE public.attendance_events (
  id uuid DEFAULT gen_random_uuid(),
  student_id text,
  event_type text, -- 'IN', 'OUT'
  timestamp timestamptz DEFAULT now(),
  device_id text,
  recorded_by uuid,
  PRIMARY KEY (id),
  FOREIGN KEY (student_id) REFERENCES public.students(id),
  FOREIGN KEY (recorded_by) REFERENCES public.profiles(id)
);

CREATE TABLE public.attendance (
  id uuid DEFAULT gen_random_uuid(),
  student_id text,
  date date,
  status text, -- 'present', 'absent', 'late', 'excused', 'clinic'
  recorded_by uuid,
  timestamp timestamptz DEFAULT now(),
  class_id text,
  session text, -- 'AM', 'PM'
  entry_type text, -- 'manual', 'QR', 'auto'
  method text,
  remarks text, -- Can reference excuse_letter_id or clinic_visit_id
  PRIMARY KEY (id),
  FOREIGN KEY (student_id) REFERENCES public.students(id),
  FOREIGN KEY (recorded_by) REFERENCES public.profiles(id)
);

CREATE TABLE public.subject_attendance (
  id uuid DEFAULT gen_random_uuid(),
  student_id text,
  subject_code text,
  date date,
  status text, -- 'present', 'absent', 'late', 'excused', 'clinic'
  recorded_by uuid,
  remarks text, -- Added: Can reference excuse_letter_id or clinic_visit_id
  recorded_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (student_id) REFERENCES public.students(id),
  FOREIGN KEY (subject_code) REFERENCES public.subjects(code),
  FOREIGN KEY (recorded_by) REFERENCES public.profiles(id)
);

CREATE TABLE public.attendance_validations (
  id uuid DEFAULT gen_random_uuid(),
  attendance_id uuid,
  validated_by uuid,
  status text,
  class_id text,
  teacher_id uuid,
  subject text,
  session text,
  attendance_date date,
  remarks text,
  validated_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (attendance_id) REFERENCES public.attendance(id),
  FOREIGN KEY (validated_by) REFERENCES public.profiles(id),
  FOREIGN KEY (teacher_id) REFERENCES public.teachers(id),
  CHECK (session IN ('AM','PM')),
  UNIQUE (class_id, subject, session, attendance_date)
);

-- 4. Excuse & Clinic Modules
CREATE TABLE public.excuse_letters (
  id uuid DEFAULT gen_random_uuid(),
  student_id text,
  parent_id uuid,
  absent_date date, -- Added: The date the student is/was absent
  reason text,
  status text, -- 'pending', 'approved', 'rejected'
  remarks text, -- Added: Teacher feedback
  issued_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (student_id) REFERENCES public.students(id),
  FOREIGN KEY (parent_id) REFERENCES public.parents(id)
);

CREATE TABLE public.clinic_visits (
  id uuid DEFAULT gen_random_uuid(),
  student_id text,
  visit_time timestamptz DEFAULT now(),
  reason text,
  treated_by uuid,
  notes text,
  status text, -- Added: 'checked_in', 'treated', 'released'
  PRIMARY KEY (id),
  FOREIGN KEY (student_id) REFERENCES public.students(id),
  FOREIGN KEY (treated_by) REFERENCES public.clinic_staff(id)
);

CREATE TABLE public.clinic_passes (
  id uuid DEFAULT gen_random_uuid(),
  student_id text,
  clinic_visit_id uuid,
  issued_by uuid,
  issued_at timestamptz DEFAULT now(),
  reason text,
  status text, -- 'pending', 'approved', 'rejected', 'used'
  PRIMARY KEY (id),
  FOREIGN KEY (student_id) REFERENCES public.students(id),
  FOREIGN KEY (clinic_visit_id) REFERENCES public.clinic_visits(id),
  FOREIGN KEY (issued_by) REFERENCES public.profiles(id)
);

-- 5. Utilities & Logs
CREATE TABLE public.qr_codes (
  id uuid DEFAULT gen_random_uuid(),
  student_id text,
  qr_hash text UNIQUE,
  is_active boolean DEFAULT true,
  created_by uuid,
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (student_id) REFERENCES public.students(id),
  FOREIGN KEY (created_by) REFERENCES public.profiles(id)
);

CREATE TABLE public.announcements (
  id uuid DEFAULT gen_random_uuid(),
  title text,
  content text,
  audience text[] DEFAULT '{}',
  is_pinned boolean DEFAULT false,
  posted_by uuid,
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (posted_by) REFERENCES public.profiles(id)
);

CREATE TABLE public.notifications (
  id uuid DEFAULT gen_random_uuid(),
  recipient_id uuid,
  actor_id uuid,
  verb text,
  object jsonb DEFAULT '{}'::jsonb,
  read boolean DEFAULT false,
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (recipient_id) REFERENCES public.profiles(id),
  FOREIGN KEY (actor_id) REFERENCES public.profiles(id)
);

CREATE TABLE public.school_calendar (
  id uuid DEFAULT gen_random_uuid(),
  type text,
  title text,
  start_date date,
  end_date date,
  notes text,
  grade_scope text DEFAULT 'all',
  created_by uuid,
  event_date date,
  description text,
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (created_by) REFERENCES public.profiles(id)
);

CREATE TABLE public.system_settings (
  id uuid DEFAULT gen_random_uuid(),
  key text,
  value jsonb DEFAULT '{}'::jsonb,
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  UNIQUE (key)
);

CREATE TABLE public.audit_logs (
  id uuid DEFAULT gen_random_uuid(),
  actor_id uuid,
  action text,
  target_table text,
  target_id text,
  details jsonb DEFAULT '{}'::jsonb,
  created_at timestamptz DEFAULT now(),
  PRIMARY KEY (id),
  FOREIGN KEY (actor_id) REFERENCES public.profiles(id)
);

-- Recommended indexes
CREATE INDEX IF NOT EXISTS idx_attendance_student_ts ON public.attendance (student_id, timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_attendance_ts ON public.attendance (timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_subject_attendance_student_date ON public.subject_attendance (student_id, date);
CREATE INDEX IF NOT EXISTS idx_clinic_visits_student_time ON public.clinic_visits (student_id, visit_time DESC);
CREATE INDEX IF NOT EXISTS idx_parent_students_student ON public.parent_students (student_id);
CREATE INDEX IF NOT EXISTS idx_announcements_created ON public.announcements (created_at DESC);
